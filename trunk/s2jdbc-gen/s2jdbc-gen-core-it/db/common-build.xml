<?xml version="1.0" encoding="UTF-8"?>
<project name="s2jdbc-gen-common" default="dump-db-meta" basedir=".">
	
	<target name="testFromDbToEntity" >
		<!-- setUp -->
		<delete dir="temp"/>
		<mkdir dir="temp/build"/>
		<copy todir="temp/build">
			<fileset dir="resources">
				<include name="**"/>
			</fileset>
		</copy>
		<exec-sql classpathref="classpath">
			<sqlFileList dir="sql">
				<file name="setup-supported.sql"/>
			</sqlFileList>
		</exec-sql>
		<!-- test -->
		<gen-entity
			rootpackagename="example"
			javafiledestdir="temp/src"
			overwrite="true"
			classpathRef="classpath"
		/>
		<javac 
			srcdir="temp/src"
			destdir="temp/build"
			classpathref="classpath"
			encoding="UTF-8"
			fork="true"
			debug="on"
		/>
		<gen-ddl 
			classpathDir="temp/build"
			rootpackagename="example"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
			classpathref="classpath"
		/>
		<!-- tearDown -->
		<exec-sql classpathref="classpath">
			<sqlFileList dir="sql">
				<file name="teardown-supported.sql"/>
			</sqlFileList>
		</exec-sql>
	</target>
	
	<target name="testFromEntityToDb" >
		<!-- setUp -->
		<delete dir="temp"/>
		<mkdir dir="temp/build"/>
		<mkdir dir="temp/result"/>
		<copy todir="temp/build">
			<fileset dir="resources">
				<include name="**"/>
			</fileset>
		</copy>
		<javac 
			srcdir="../../src/main/java"
			destdir="temp/build"
			classpathref="classpath"
			encoding="UTF-8"
			fork="true"
			debug="on"
		/>
		<!-- test -->
		<gen-test
			classpathDir="temp/build"
			rootpackagename="example"
			javafiledestdir="temp/src"
			overwrite="true"
			classpathRef="classpath"
		/>
		<gen-condition
			classpathDir="temp/build"
			rootpackagename="example"
			javafiledestdir="temp/src"
			overwrite="true"
			classpathRef="classpath"
		/>
		<gen-service
			classpathDir="temp/build"
			rootpackagename="example"
			javafiledestdir="temp/src"
			overwrite="true"
			classpathRef="classpath"
		/>
		<javac 
			srcdir="temp/src"
			destdir="temp/build"
			classpathref="classpath"
			encoding="UTF-8"
			fork="true"
			debug="on"
		/>
		<gen-ddl 
			classpathDir="temp/build"
			rootpackagename="example"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
			classpathref="classpath"
		/>
		<migrate 
			classpathref="classpath"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
		/>
		<junit haltonfailure="no" printsummary="true">
			<formatter type="xml"/>
			<classpath refid="classpath"/>
			<batchtest todir="temp/result" fork="true">
				<fileset dir="temp/src">
					<include name="example/entity/*Test.java"/>
				</fileset>
			</batchtest>
		</junit>
		<!-- tearDown -->
		<migrate 
			classpathref="classpath"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
			version="0"
		/>
	</target>
	
	<target name="testMigrate" >
		<!-- setUp -->
		<delete dir="temp"/>
		<mkdir dir="temp/build"/>
		<copy todir="temp/build">
			<fileset dir="resources">
				<include name="**"/>
			</fileset>
		</copy>
		<exec-sql classpathref="classpath">
			<sqlFileList dir="sql">
				<file name="setup-supported.sql"/>
			</sqlFileList>
		</exec-sql>
		<gen-entity
			rootpackagename="example"
			javafiledestdir="temp/src"
			overwrite="true"
			classpathRef="classpath"
		/>
		<exec-sql classpathref="classpath">
			<sqlFileList dir="sql">
				<file name="teardown-supported.sql"/>
			</sqlFileList>
		</exec-sql>
		<javac 
			destdir="temp/build"
			classpathref="classpath"
			encoding="UTF-8"
			fork="true"
			debug="on">
			<src path="temp/src"/>
			<src path="../../src/main/java"/>
		</javac>
		<!-- test -->
		<gen-ddl 
			classpathDir="temp/build"
			rootpackagename="example"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
			classpathref="classpath"
		/>
		<migrate 
			classpathref="classpath"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
		/>
		<gen-ddl 
			classpathDir="temp/build"
			rootpackagename="example"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
			classpathref="classpath"
		/>
		<migrate 
			classpathref="classpath"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
		/>
		<!-- tearDown -->
		<migrate 
			classpathref="classpath"
			migratedir="temp/db/migrate"
			ddlversionfile="temp/db/ddl-version.txt"
			version="0"
		/>
	</target>

	<target name="dump-db-meta" >
		<!-- setUp -->
		<delete dir="temp"/>
		<mkdir dir="temp/build"/>
		<copy todir="temp/build">
			<fileset dir="resources">
				<include name="**"/>
			</fileset>
		</copy>
		<exec-sql classpathref="classpath">
			<sqlFileList dir="sql">
				<file name="setup-supported.sql"/>
				<file name="setup-unsupported.sql"/>
			</sqlFileList>
		</exec-sql>
		<!-- test -->
		<dump-db-meta
			classpathRef="classpath"
		/>
		<!-- tearDown -->
		<exec-sql classpathref="classpath">
			<sqlFileList dir="sql">
				<file name="teardown-supported.sql"/>
				<file name="teardown-unsupported.sql"/>
			</sqlFileList>
		</exec-sql>
	</target>
</project>
