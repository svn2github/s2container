<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head><title>Seasar - DI Container with AOP - </title>
<meta http-equiv="Content-Type" content="text/html; charset=MS932C">
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen"><link href="seasar_p.css" type="text/css" rel="stylesheet" media="print"><script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head><body onload="preload('ja')"><table width="100%" border="0" cellspacing="0" cellpadding="0" align="left"><tr>
<td align="left" valign="top" width="780"><table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr><td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt=""></td></tr>
<tr><td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar"></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP"></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt=""></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)"></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></td>
<td><img height="30" width="34" src="images/menu06.gif" alt=""></td></tr><tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt=""></td></tr></table>
<table  width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top"><td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td><td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->
<p>S2JUnit4は<a href="http://www.junit.org/index.htm">JUnit4</a>を拡張したテスティングフレームワークです。
S2JUnit4はアノテーションと命名規則の双方を利用し少ないコードで効率のよいテストを可能にします。
Seasar2ではテスティングフレームワークとしてすでに<a href="S2Unit.html">S2Unit</a>を提供していますが、S2JUnit4はJUnit4の対応に加えS2Unitの次の機能を自動化することを特長としています。</p>
<ul>
<li>diconファイルのinclude</li>
<li>Excelに用意した事前データのデータベースへの書き出し</li>
<li>トランザクションの開始とロールバック</li>
</ul>
<p>S2JUnit4の主な機能には次のものがあります。</p>
<ul>
<li>javaee5.diconを自動でincludeします。</li>
<li>public、非static、引数なし、戻り値なしのメソッドをテストメソッドとみなします。Testアノテーションがついているものもついていないものも等しくテストメソッドとみなします。</li>
<li>beforeXxx、afterXxx、という命名規則に従ったメソッドを個別のテストメソッドの前後に実行します。（S2UnitにおけるsetUpXxx、tearDownXxxに相当します。）</li>
<li>テストメソッド実行前に自動的にトランザクションを開始し、トランザクション終了後に自動的にロールバックを行います。トランザクションの振る舞いはTxBehaviorアノテーションを使うことで変更できます。TxBehaviorアノテーションに指定できるTxBehaviorTypeにはNONE（トランザクションを開始しない）、COMMIT（トランザクションをコミットする）、ROLLBACK（トランザクションをロールバックする）の3種類があります。ROLLBACKがデフォルトの振る舞いです。</li>
<li>「テストクラス名_.dicon」という名称のdiconファイルがテストクラスと同一のパッケージもしくはクラスパスのルートに存在すればテストメソッド実行前に自動的にincludeします。</li>
<li>「テストクラス名_テストメソッド名.xls」もしくは「テストクラス名.xls」という名称のExcelがテストクラスと同一のパッケージもしくはクラスパスのルートに存在すればテストメソッド実行前に自動的に読み込みデータベースに書き込みます。S2JUnit4は最初に「テストクラス名_テストメソッド名.xls」を存在検査し存在すれば「テストクラス名_テストメソッド名.xls」を使用し、存在しない場合は「テストクラス名.xls」を使用します。</li>
<li>インターフェース型のフィールドがテストクラスに宣言されている場合、その型のコンポーネントがコンテナに存在すればS2JUnit4はそのコンポーネントをフィールドに設定します。</li>
<li>非static、非finalなフィールドがテストクラスに宣言されている場合、その名前からアンダースコア(_)を除いた名前のコンポーネントがコンテナに登録されていれば、S2JUnit4はそのコンポーネントをフィールドに設定します。</li>
<li>DataAccessorクラスがテストクラスのフィールドに宣言されている場合、S2JUnit4はDataAccessorクラスのインスタンスをフィールドに設定します。DataAccessorクラスはExcelとデータベースにアクセスするためのメソッド群を持ちます。</li>
<li>S2Assertクラスのメソッドをstatic importすることでS2JUnit4固有のアサーションメソッドを実行できます。</li>
<li>diconファイルを使い、上に述べた機能をカスタマイズすることができます。たとえば、beforeXxx、afterXxxという命名規則を変更したり、独自アノテーションを使って振る舞いを拡張したりすることができます。</li>
</ul>
<h2><a name="Example">Example</a></h2>

<h2><a name="SelectTest">Select文に対するテスト</a></h2>
<p>S2Unitのサンプルと同様、従業員を従業員番号で検索するDAOをサンプルとします。
シナリオとして従業員番号9900で検索をかけると、従業員番号9900の従業員テーブルと部署番号99の部署テーブルをジョインして返す想定とします。
このケースをテストするためには、検索のための従業員テーブルと部署テーブルのデータと検索した結果を検証するためのデータが必要です。
データはExcelで用意します。データの作り方などについては適宜<a href="S2Unit.html#SelectTest">S2Unitのサンプル</a>を参照してください。
</p>

<p>
従業員テーブルと部署テーブルの事前データのExcelはS2JUnitが自動で読み込みデータベースへ書き込めるように「テストクラス名_メソッド名.xls」、すなわちここでは「EmployeeDaoImplTest_getEmployee.xls」という名前にし、テストクラスと同一パッケージ内に置きます。
検索した結果を検証するための期待値データのExcelはテストメソッド内で明示的に指定します。
ここではわかりやすく「EmployeeDaoImplTest_getEmployee_Expected.xls」という名前にします。
</p>

<h3>examples.s2junit4.EmployeeDaoImplTest.dicon</h3>
<pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container 2.4//EN" 
    "http://www.seasar.org/dtd/components24.dtd"&gt;
&lt;components&gt;
    &lt;include path="javaee5.dicon"/&gt;
    &lt;component class="examples.s2junit4.EmployeeDaoImpl"&gt;
        &lt;property name="getEmployeeHandler"&gt;
            &lt;component class="org.seasar.extension.jdbc.impl.BasicSelectHandler"&gt;
                &lt;property name="sql"&gt;
"SELECT e.empno, e.ename, e.deptno, d.dname FROM emp e, dept d
WHERE e.empno = ? AND e.deptno = d.deptno"
                &lt;/property&gt;
                &lt;property name="resultSetHandler"&gt;
                    &lt;component class="org.seasar.extension.jdbc.impl.BeanResultSetHandler"&gt;
                        &lt;arg&gt;@examples.s2junit4.Employee@class&lt;/arg&gt;
                    &lt;/component&gt;
                &lt;/property&gt;
            &lt;/component&gt;
        &lt;/property&gt;
    &lt;/component&gt;
&lt;/components&gt;
</pre>
<p>
diconファイルではDAOの実装の設定を行います。
S2JUnit4が自動でdiconファイルをincludeできるようにdiconファイルは「テストクラス名.dicon」すなわち「EmployeeDaoImplTest.dicon」という名前とし、テストクラスと同一パッケージ内に置きます。
</p>

<h3>examples.s2junit4.EmployeeDaoImplTest</h3>
<pre>
package examples.s2junit4;

import static org.seasar.framework.unit.S2Assert.assertEquals;

import org.junit.Ignore;
import org.junit.runner.RunWith;
import org.seasar.extension.dataset.DataSet;
import org.seasar.framework.unit.DataAccessor;
import org.seasar.framework.unit.Seasar2;

@RunWith(Seasar2.class)
public class EmployeeDaoImplTest {

    private EmployeeDao dao;

    private DataAccessor da;

    public void getEmployee() throws Exception {
        Employee emp = dao.getEmployee(9900);
        DataSet expected = da
                .readXls("EmployeeDaoImplTest_getEmployee_Expected.xls");
        assertEquals("1", expected, emp);
    }

    @Ignore("not implemented.")
    public void getEmployeeByName() throws Exception {
    }

}
</pre>
<p>S2JUnit4でテストクラスを実行するには@RunWith(Seasar2.class)の指定が必要です。public、非static、引数なし、戻り値なしのメソッドがテストメソッドとして実行されます。Ignoreアノテーションが指定されているテストメソッドは実行されません。従って、ここではgetEmployeeメソッドのみが実行されます。</p>
<p>
インターフェース型でインスタンス変数(dao)を宣言しておけば、テストメソッドを開始する前にS2Containerから取り出されて自動的に設定されます。
期待値をもつExcelを読み込むためにはDataAccessorクラスのreadXlsメソッドを使います。DataAccessorクラスのインスタンスは宣言しておけば自動的に設定されます。
DataSetとBeanを比較し値が等しいことを検証するにはS2AssertクラスのassertEqualsメソッドを利用します。このメソッドはstatic importの宣言をしておくことで簡潔に利用できます。
</p>
<p>テストメソッドを実行する処理の流れをgetEmployeeメソッドの実行に則して説明すると次のようになります。</p>
<ol>
<li>Ignoreアノテーションが指定されていないことを確認する（指定されていれば以下の一連の処理は行わない）</li>
<li>javaee5.diconが存在すれば自動でincludeする</li>
<li>EmployeeDaoImplTest.diconが存在すれば自動でincludeする</li>
<li>Beforeアノテーションが指定されたメソッドが存在すれば実行する</li>
<li>beforeGetEmployeeメソッドが存在すれば実行する</li>
<li>EmployeeDaoImplとDataAccessorのインスタンスをフィールドに設定する</li>
<li>トランザクションを開始する</li>
<li>EmployeeDaoImplTest_getEmployee_.xlsが存在すれば読み込んでデータベースに書き込む</li>
<li>EmployeeDaoImplTest.xlsが存在すれば読み込んでデータベースに書き込む</li>
<li>getEmployeeメソッドを実行する</li>
<li>トランザクションをロールバックする</li>
<li>afterGetEmployeeメソッドが存在すれば実行する</li>
<li>Afterアノテーションが指定されたメソッドが存在すれば実行する</li>
</ol>

<h2><a name="Customization">S2JUnit4のカスタマイズ</a></h2>
<p>
diconファイルにコンポーネントを指定することでS2JUnit4の振る舞いを変更することができます。
カスタマイズのためのコンポーネントを含むdiconファイルのパス名には、<code>org.seasar.unit.s2junit4.config</code>をキーとして取得できるシステムプロパティが存在する場合はその値が使われ、存在しない場合はクラスパスのルートに存在するs2junit4.diconが使われます。
diconファイルに設定できるコンポーネントはorg.seasar.framework.unitパッケージ内の次のインタフェースの実装のすべてまたはいずれかです。
<ul>
<li>Seasar2.Configurator</li>
<li>Seasar2.Provider</li>
<li>S2TestClassMethodsRunner.Provider</li>
<li>S2TestMethodRunner.Provider</li>
<li>TestIntrospector</li>
</ul>
</p>

<!-- document end -->
<!-- don't edit start -->
</td>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td>
</tr><tr>
<td width="14"><img height="30" width="14" src="images/spacer.gif" alt=""></td>
<td width="766"><img height="30" width="592" src="images/spacer.gif" alt=""></td>
</tr><tr>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td>
<td width="766" class="copyright">Copyright&copy; 2004-2005, The Seasar Foundation and the others. All rights reserved.</td>
</tr></table>
<td class="backright" align="left" valign="top">&nbsp;</td></tr><tr>
<td class="backunder" align="left"  valign="top" width="780" height="16">&nbsp;</td>
<td class="backcorner" align="left" valign="top" height="16">&nbsp;</td>
</tr></table></body>
<!-- don't edit end -->
</html>
