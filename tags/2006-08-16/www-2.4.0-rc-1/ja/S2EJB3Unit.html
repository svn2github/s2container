<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head><title>Seasar - DI Container with AOP - </title>
<meta http-equiv="Content-Type" content="text/html; charset=MS932C">
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen"><link href="seasar_p.css" type="text/css" rel="stylesheet" media="print"><script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head><body onload="preload('ja')"><table width="100%" border="0" cellspacing="0" cellpadding="0" align="left"><tr>
<td align="left" valign="top" width="780"><table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr><td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt=""></td></tr>
<tr><td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar"></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP"></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt=""></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)"></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></td>
<td><img height="30" width="34" src="images/menu06.gif" alt=""></td></tr><tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt=""></td></tr></table>
<table  width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top"><td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td><td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->
<p>
S2EJB3Unitは<a href="S2Unit.html">S2Unit</a>を拡張したテスティングフレームワークです。
S2EJB3UnitはEJB 3.0のコンポーネントとJava Persistence API（JPA）のエンティティに対するテストを効率化します。
S2EJB3Unitには次の特長があります。
</p>
<ul>
<li>ejb3.diconとhibernate-jpa.diconを自動的にincludeします。</li>
<li>registerメソッドによりEJB 3.0コンポーネントを組立てることができます。</li>
<li>Rollbackアノテーションが指定されたテストメソッドの実行前にトランザクションを開始し実行後にトランザクションをロールバックします。</li>
<li>EntityManagerを返すgetEntityManagerを提供します。</li>
<li>assertEntityEqualsメソッドもしくはassertEntityListEqualsメソッドによりExcelの期待値データとJPAのエンティティを比較します。</li>
</ul>
<h2><a name="Example">Example</a></h2>
<h2><a name="EJB3">EJB 3.0を使ったテスト</a></h2>
<p>このサンプルでは、従業員の名前を返すServiceのステートレスセッションBeanをテストします。
シナリオとして従業員番号9900で検索をかけると従業員番号9900の従業員名を返すということを想定します。
ServiceのステートレスセッションBeanはDAOのステートレスセッションBeanを呼び出し、DAOのステートレスセッションBeanはデータベースにアクセスします。
データベースのアクセスにはJDBC APIを利用します。
このケースをテストするためには、検索のための従業員テーブルのデータが必要です。
データはExcelで用意します。データの作り方などについては適宜<a href="S2Unit.html#SelectTest">S2Unitのサンプル</a>を参照してください。
</p>

<p>
ServiceとDAOそれぞれにビジネスインタフェースとステートレスセッションBeanを用意します。
</p>

<h3>examples.s2ejb3unit.EmployeeService</h3>
<pre>
package examples.s2ejb3unit;

public interface EmployeeService {

    String getEmployeeName(int empno);
}

</pre>

<h3>examples.s2ejb3unit.EmployeeServiceImpl</h3>
<pre>
package examples.s2ejb3unit;

import javax.ejb.EJB;
import javax.ejb.Stateless;

@Stateless
public class EmployeeServiceImpl implements EmployeeService {

    @EJB
    private EmployeeDao dao;

    public String getEmployeeName(int empno) {
        return dao.getEmployeeName(empno);
    }

}
</pre>

<h3>examples.s2ejb3unit.EmployeeDao</h3>
<pre>
package examples.s2ejb3unit;

public interface EmployeeDao {

    String getEmployeeName(int empno);
}
</pre>

<h3>examples.s2ejb3unit.EmployeeDaoImpl</h3>
<pre>
package examples.s2ejb3unit;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.annotation.Resource;
import javax.ejb.Stateless;
import javax.sql.DataSource;

@Stateless
public class EmployeeDaoImpl implements EmployeeDao {

    @Resource
    DataSource ds;

    public String getEmployeeName(int empno) {
        String ename = null;
        try {
            Connection con = ds.getConnection();
            try {
                PreparedStatement ps = con
                        .prepareStatement("SELECT ename FROM emp WHERE empno = ?");
                try {
                    ps.setInt(1, empno);
                    ResultSet rs = ps.executeQuery();
                    try {
                        if (rs.next()) {
                            ename = rs.getString("ename");
                        }
                    } finally {
                        rs.close();
                    }
                } finally {
                    ps.close();
                }
            } finally {
                con.close();
            }
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
        return ename;
    }
}
</pre>


<h3>examples.s2ejb3unit.EmployeeServiceImplTest</h3>
<pre>
package examples.s2ejb3unit;

import javax.ejb.EJB;

import org.seasar.framework.ejb.unit.S2EJB3TestCase;
import org.seasar.framework.unit.annotation.Rollback;

public class EmployeeServiceImplTest extends S2EJB3TestCase {

    @EJB
    private EmployeeService service;

    @Override
    public void setUp() throws Exception {
        super.setUp();
        register(EmployeeDaoImpl.class);
        register(EmployeeServiceImpl.class);
    }

    @Rollback
    public void testGetEmployee() throws Exception {
        readXlsWriteDb("EmployeeServiceImplTest_getEmployeeName.xls");
        assertEquals("1", "SCOTT2", service.getEmployeeName(9900));
    }

}
</pre>
<p>
テストクラスはS2EJB3TestCaseを継承します。
setUpメソッド内でregisterメソッドを呼ぶことでEJB 3.0のコンポーネントをコンテナに登録できます（setUpメソッドでは必ずsuper.setUp()を実行してください）。まとめて複数登録する場合や、コンポーネントの組み立て方が複雑な場合はdiconファイルを使い明示的にincludeします。
EJBアノテーションが指定されたフィールドには自動的にEJBのコンポーネントが設定されます。
</p>
<p>
テストメソッド実行前にトランザクションを開始し、実行後にトランザクションをロールバックしたい場合はテストメソッドにRollbackアノテーションを指定します。
</p>

<h2><a name="JPA">Java Persistence APIを使ったテスト</a></h2>
このサンプルでは、従業員エンティティをテストします。
それぞれのテストメソッドでは事前データをデータベースに書き込み、その後エンティティを取得し期待値と比較しています。
<pre>
public class EmployeeTest extends S2EJB3TestCase {

    @Rollback
    public void testFindEmployee() {
        readXlsWriteDb("Prepare.xls");
        DataSet expected = readXls("findEmployeeResult.xls");
        Employee actual = getEntityManager().find(Employee.class, new Long(1));
        assertEntityEquals("0", expected, actual);
    }

    @Rollback
    public void testFindEmployeeAndRelationship() {
        readXlsWriteDb("Prepare.xls");
        DataSet expected = readXls("findEmployeeRelationshipsResult.xls");
        Employee actual = getEntityManager().find(Employee.class, new Long(1));
        assertEntityEquals("0", expected, actual, true);
    }

    @Rollback
    public void testSelectAllEmployees() {
        readXlsWriteDb("Prepare.xls");
        DataSet expected = readXls("selectAllEmployeesResult.xls");
        List actual = getEntityManager().createQuery(
                "select e From Employee e").getResultList();
        assertEntityListEquals("0", expected, actual);
    }

    @Rollback
    public void testSelectAllEmployeesAndRelationships() {
        readXlsWriteDb("Prepare.xls");
        DataSet expected = readXls("selectAllEmployeesRelationshipsResult.xls");
        List actual = getEntityManager().createQuery(
                "select e From Employee e").getResultList();
        assertEntityListEquals("0", expected, actual, true);
    }
}

</pre>
<p>
getEntityManagerメソッドを使いEntityManagerにアクセスしています。
EntityManagerを取得するにはhibernate-jpa.diconが読み込まれている必要があります。
hibernate-jpa.diconは<a href="http://s2hibernate.seasar.org/ja/s2hibernate-jpa.html">S2Hibernate-JPA</a>の設定ファイルです。
S2EJB3Unitは現在S2Hibernate-JPAとの連携のみをサポートしています。
</p>
<p>
S2EJB3TestCaseにはエンティティを期待値のDataSetと比較するためのアサートメソッドが4つ用意されています。
<ol>
<li>assertEntityEquals(String message, DataSet expected, Object entity)</li>
<li>assertEntityEquals(String message, DataSet expected, Object entity, boolean includesRelationships) </li>
<li>assertEntityListEquals(String message, DataSet expected, Object entity)</li>
<li>assertEntityListEquals(String message, DataSet expected, Object entity, boolean includesRelationships) </li>
</ol>
</p>
<p>
assertEntityEqualsメソッドは単一のエンティティとDataSetを比較します。
assertEntityListEqualsメソッドはエンティティのリストとDataSetを比較します。
assertEntityEqualsメソッドとassertEntityListEqualsメソッドはそれぞれ4つの引数をもつオーバーロードされたメソッドを持ちます。
4番目の引数であるincludesRelationshipsは、比較対象にエンティティのリレーションシップを含めるかどうかのbooleanです。
たとえば従業員エンティティが部門エンティティとリレーションシップをもちassertEntityEqualsメソッドの引数に従業員エンティティが渡されるとき、includesRelationshipsがfalseならば部門エンティティは比較対象になりません。trueのときは比較対象になります。
3つの引数をもつassertEntityEqualsメソッドとassertEntityListEqualsメソッドを利用する場合、includesRelationshipsはfalseだとみなされます。
</p>

<!-- document end -->
<!-- don't edit start -->
</td>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td>
</tr><tr>
<td width="14"><img height="30" width="14" src="images/spacer.gif" alt=""></td>
<td width="766"><img height="30" width="592" src="images/spacer.gif" alt=""></td>
</tr><tr>
<td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td>
<td width="766" class="copyright">Copyright&copy; 2004-2005, The Seasar Foundation and the others. All rights reserved.</td>
</tr></table>
<td class="backright" align="left" valign="top">&nbsp;</td></tr><tr>
<td class="backunder" align="left"  valign="top" width="780" height="16">&nbsp;</td>
<td class="backcorner" align="left" valign="top" height="16">&nbsp;</td>
</tr></table></body>
<!-- don't edit end -->
</html>
